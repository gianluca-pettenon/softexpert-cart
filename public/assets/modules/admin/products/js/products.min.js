$(document).ready(function () {

    $('#txtProductPrice').mask('##0.00', { reverse: true });

    var tblProducts = $("#tblProducts").DataTable({
        ajax: {
            url: '/product',
            type: "POST",
            dataType: "json",
            dataSrc: function (data) {
                if (data) {
                    if (data.data) {
                        return data.data;
                    }
                }

                return {};
            },
            error: function (xhr, ajaxOptions, thrownError) {
                console.log(xhr);
                Message.Toast({ 'message': thrownError, 'class': 'danger' });
            },
            complete: function (xhr, status) { },
        },

        columns:
            [
                {
                    title: "PRODUTO",
                    data: "name"
                },
                {
                    title: "PRE&Ccedil;O",
                    data: "price",
                    render: function (data, type, row) {
                        return 'R$' + data;
                    }
                },
                {
                    title: "IMPOSTO",
                    data: "tax",
                    render: function (data, type, row) {
                        return data + '%';
                    }
                },

            ],

        processing: false,
        bInfo: false,
        ordering: false,
        responsive: true,
        dom: "Bfrtp",
        buttons: [
            {
                text: "ADICIONAR",
                className: "btn-dark btn-sm",
                action: function () {
                    $('#modalProduct').modal('show');
                }
            },
        ],

        language: Language.DataTable

    });

    $("#btnProduct").off("click").on("click", function () {

        let params = [
            {
                field: "name",
                value: $("#txtProductName").val(),
                required: true,
            },
            {
                field: "type",
                value: $("#txtProductType").val(),
                required: true,
            },
            {
                field: "price",
                value: $("#txtProductPrice").val(),
                required: true,
            }
        ];

        if(Validate.requiredFields(params)) {
            return false;
        }

        $("#btnProduct").prop('disabled', true);

        $.ajax({
            url: "/product/create",
            type: "POST",
            data: params,
            success: function (data) {

                if (data) {
                    Message.Toast(data);
                }

                tblProducts.ajax.reload();

            },
            error: function (xhr, ajaxOptions, thrownError) {
                console.log(xhr);
                Message.Toast({ 'message': thrownError, 'class': 'danger' });
            },
            complete: function (xhr, status) {
                $("#formProduct").trigger('reset');
            },
        });

        $("#btnProduct").prop('disabled', false);

        $('#modalProduct').modal('hide');

    });

    function loadType() {
        $.ajax({
            url: '/product/type',
            type: 'POST',
            success: function (data) {
                if (data) {
                    Fill.Select($("#txtProductType"), data.data);
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                console.log(xhr);
                Message.Toast({ 'message': thrownError, 'class': 'danger' });
            },
            complete: function (xhr, status) { },
        });
    }


    loadType();

});